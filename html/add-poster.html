<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Channel - Add Poster</title>

        <!-- Import font awesome -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

        <!-- Import css -->
        <link rel="stylesheet" href="../assets/css/styles.css">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    </head>

    <body>
        <div style="display: flex; align-items: flex-start; width: 100%;">
            <input type="checkbox" id="toggle-checkbox">
            
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="logo-container">
                    <h3 class="logo">Channel</h3>
                    <span class="seperate-bar"></span>
                </div>

                <div class="sidebar-section">
                    <h4 class="heading">General</h4>

                    <ul class="option-list">
                        <li class="option-item">
                            <span class="mark-bar"></span>
                            <a class="option-link" href="http://localhost:5500/index.html">
                                <span class="option-icon">
                                    <i class="fa-solid fa-chart-simple"></i>
                                </span>
                                
                                <p>Dashboard</p>
                            </a>

                            <p class="option-name">Dashboard</p>
                        </li>
                    </ul>
                </div>

                <div class="sidebar-section">
                    <h4 class="heading">Management</h4>

                    <ul class="option-list">
                        <li class="option-item">
                            <span class="mark-bar"></span>
                            <a class="option-link" href="http://127.0.0.1:3001/html/product-management.html">
                                <span class="option-icon">
                                    <i class="fa-solid fa-box-archive"></i>
                                </span>

                                <p>Product</p>
                            </a>

                            <p class="option-name">Product</p>
                        </li>

                        <li class="option-item poster">
                            <span class="mark-bar"></span>
                            <a class="option-link" href="http://127.0.0.1:3001/html/poster-management.html">
                                <span class="option-icon">
                                    <i class="fa-solid fa-clipboard"></i>
                                </span>
                                
                                <p>Poster</p>
                            </a>

                            <p class="option-name">Poster</p>
                        </li>

                        <li class="option-item">
                            <span class="mark-bar"></span>
                            <a class="option-link" href="http://127.0.0.1:3001/html/coupon-management.html">
                                <span class="option-icon">
                                    <i class="fa-solid fa-ticket"></i>
                                </span>
                                
                                <p>Coupon</p>
                            </a>

                            <p class="option-name">Coupon</p>
                        </li>
                    </ul>
                </div>

                <div class="toggle-wrapper">
                    <span class="seperate-bar"></span>

                    <div class="align-toggle">
                        <h4>Toggle Sidebar</h4>

                        <label for="toggle-checkbox" class="switch">
                            <span class="round"></span>
                        </label>
                    </div>
                </div>
            </aside>
            <!-- End Sidebar -->

            <!-- Main -->
            <main class="main-body">
                <!-- Main Header -->
                <header class="main-header">
                    <div class="search-bar">
                        <i class="fa-solid fa-magnifying-glass"></i>
                        <input type="text" placeholder="Start searching here...">
                    </div>
                    
                    <div class="main-header-left">
                        <div class="notify-wrapper">
                            <p class="notify-quantity">99</p>

                            <div class="icon">
                                <i class="fa-regular fa-bell"></i>
                            </div>
                        </div>

                        <div class="user-card-wrapper">
                            <i class="fa-solid fa-bars"></i>    

                            <div class="user-card">
                                <span class="image"></span>
                                
                                <div class="user-card-info">
                                    <p class="name">Đặng Quốc Hiệp</p>
                                    <p class="email">danghiep100@gmail.com</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </header>
                <!-- End Main Header -->

                <div class="content-poster">
                    <header class="heading">
                        <div class="align-heading">
                            <h3>Add poster</h3>
                            <a href="http://127.0.0.1:3001/html/poster-management.html" class="button-add">Turn back</a>
                        </div>

                        <span class="seperate-bar"></span>
                    </header>

                    <form class="form-poster">
                        <div class="form-group">
                            <label for="input-name">Poster's name</label>
                            <input type="text" class="input-name" id="input-name" name="name" placeholder="Poster's name...">
                            <span class="message"></span>
                        </div>

                        <div class="form-group">
                            <label for="input-content">Poster content</label>
                            <textarea class="input-content" name="content" placeholder="Poster content..."></textarea>
                            <span class="message"></span>
                        </div>

                        <div class="form-group">
                            <label for="input-file">Choose image</label>
                            <div class="wrapper-input-file">
                                <div class="images-container"></div>
                                <label for="input-file" class="input-file-2">Choose image</label>
                                <input type="file" class="input-file" id="input-file" accept="image/*"  name="files" multiple>
                            </div>
                            <span class="message"></span>
                        </div>

                        <button type="button" class="button-add-poster">Add poster</button>
                    </form>
                </div>
            </main>
            <!-- End Main -->

            <script src="../assets/javascripts/sidebar.js"></script>
            <script src="../assets/javascripts/utils/multiple-image.js"></script>
            <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
            <script type="module" src="../assets/javascripts/posters/validation.js"></script>
            <script type="module" src="../assets/javascripts/posters/utils.js"></script>

            <script type="module">
               

                import validation from "../assets/javascripts/posters/validation.js";
                import { notify, formatString, stringInNum } from "../assets/javascripts/posters/utils.js";
                

                        // Hàm xử lý form
                        validation({
                            form: ".form-poster",
                            button: ".button-add-poster",
                            message: ".message",
                            rules: [
                        validation.isRequired(".input-name", "Please enter characters!"),
                        validation.isMin(".input-name", "Please enter at least 6 characters!"),
                        validation.isRequired(".input-content", "Please enter characters!"),
                        validation.isMin(".input-content", "Please enter at least 6 characters!"),
                        validation.isFiles(".input-file", "Please choose at least 1 file!"),
                            ],
                            onSubmit: async function(data) {
                                try {
                                    if (data) {

                                        const arrayFiles = Array.from(data.files);
                                        const files = await Promise.all(arrayFiles.map(async (file) => {
                                            const reader = new FileReader();
                                            const dataUrl = await new Promise((resolve, reject) => {
                                                reader.addEventListener("load", () => resolve(reader.result));
                                                reader.addEventListener("error", reject);
                                                reader.readAsDataURL(file);
                                            });
                                            return dataUrl;
                                        }));

                                        const ButtonAdd = document.querySelector(".button-add-poster");
                                        ButtonAdd.disabled = true;

                                        const responseGet = await fetch("http://localhost:3000/posters");
                                        const posters = await responseGet.json();

                                        if (posters.length === 0) {
                                            const response = await fetch("http://localhost:3000/posters", {
                                                method: "POST",
                                                headers: {
                                                    "Content-Type": "application/json"
                                                },
                                                body: JSON.stringify({ ...data, files }),
                                            });

                                            if (response.ok) notify("Add Poster successfully!");
                                            else notify("Add Poster fail!", false);
                                        } 
                                        else if (posters.length > 0) {
                                            const isExist = posters.find((poster) => formatString(poster.name) === formatString(data.name));
                                            if (isExist) notify("Poster đã tồn tại!", false);
                                            else {
                                                const response = await fetch("http://localhost:3000/posters", {
                                                    method: "POST",
                                                    headers: {
                                                        "Content-Type": "application/json"
                                                    },
                                                    body: JSON.stringify({ ...data, files }),
                                                });

                                                if (response.ok) notify("Add Poster successfully!");
                                                else notify("Add Poster fail!", false);
                                            }
                                        }

                                        ButtonAdd.disabled = false;
                                    }
                                }
                                catch (error) {
                                    console.log(error);
                                    notify("Thêm poster thất bại!", false);
                                }
                            }
                        });

            </script>
        </div>
    </body>
</html>